<!doctype html>
<html>
  <head>
		<!-- The '/homey.js' script must be included in your settings view to work -->
		<script type="text/javascript" src="/homey.js" data-origin="settings"></script>
		<script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
  </head>
  <body>
    <h1 data-i18n="settings.title"></h1>
    <div id="panel-buttons">
      <button id="panel-button-1" class="button panel-button" onclick="showPanel(1)" data-i18n="settings.settingsTitle">Settings</button>&nbsp;
      <button id="panel-button-2" class="button panel-button" onclick="showPanel(2)" data-i18n="settings.loggingTitle">Logging</button>&nbsp;
			<br><br>
    </div>
    <!-- Settings panel -->
  	<div id="panel-1" class="panel">
			<fieldset>
					<legend data-i18n='settings.webDavTitle'> </legend>
					<label for="webdav_url" data-i18n="settings.webDavUrl"> </label>
					<input id="webdav_url" size="70" type="text" placeholder="e.g. https://mynas:443/webdav/HomeyBackups" value="" />
					<br><br>
					<label for="username" data-i18n="settings.username"> </label>
					<input id="username" size="45" type="text" value="" />
					<br><br>
					<label for="password" data-i18n="settings.password"> </label>
					<input id="password" size="45" type="password" value="" />
					<br><br>
					<button id="button_save" class="left" onclick="save()"><i class="fa fa-save"></i> <span data-i18n="settings.save">Save</span></button>
					<button id="button_backup" class="left" onclick="backup()"><i class="fa fa fa-file-excel-o"></i> <span data-i18n="settings.backup">Export</span></button>
			</fieldset>
    </div>
    <!-- Debug logs panel -->
    <div id="panel-2" class="panel">
			<!-- <button type="button" class="right" id="button_getlog" onclick="showLogs()" data-i18n="settings.getLogs">Get Logs</button> -->
			<div id="loglines"></div>
    </div>

		<script type="text/javascript">

		var saveData;
		var HomeyAPI = null;
		var webdavUrlField = document.getElementById('webdav_url');
		var usernameField = document.getElementById('username');
		var passwordField = document.getElementById('password');
		var saveButton = document.getElementById('button_save');
		var backupButton = document.getElementById('button_backup');

		function showPanel(panel) {
		  $('.panel').hide()
		  $('.panel-button').removeClass('panel-button-active').addClass('panel-button-inactive')
		  $('#panel-button-' + panel).removeClass('panel-button-inactive').addClass('panel-button-active')
		  $('#panel-' + panel).show()
			if (panel === 2) {
				showLogs();
			}
		}

		// triggered when user opens settings page
		function onHomeyReady(Homey) {
			HomeyAPI = Homey;
			saveButton.disabled = true; // Disable save button until settings have been loaded
			backupButton.disabled = true; // Disable backup button until settings have been loaded

			Homey.get('settings', function(err, storedData) {
				if( err ) {
					return Homey.alert( err );
				} else {
					//console.log('got data: ', storedData);
					if ((storedData != null) && (storedData != undefined)) {
						webdavUrlField.value = storedData.webdav_url;
						usernameField.value = storedData.username;
						passwordField.value = storedData.password;
						backupButton.disabled = false;
					}
				}
				saveButton.disabled = false;
				showPanel(1);
				Homey.ready();  //ready to show the settings page
			});

		}
		function save() {
			saveData = {
				webdav_url: webdavUrlField.value,
				username: usernameField.value,
				password: passwordField.value
			};
			HomeyAPI.set('settings', saveData, function (error) {
				if (error) {
					HomeyAPI.alert(error, 'error');
				} else {
					HomeyAPI.alert(HomeyAPI.__("settings.settingsSaved"), 'info');
				}
			});
		};
		function backup() {
			HomeyAPI.confirm(HomeyAPI.__("settings.confirmExport"), 'warning', function( err, result ) {
				if (!result) { return; }
				backupButton.disabled = true; // Disable backup button until page is reloaded
				HomeyAPI.api('GET', '/archiveAll', function(error, result) {
					if (error) {
						HomeyAPI.alert(error, 'error');
					}
					else {
						HomeyAPI.alert(HomeyAPI.__("settings.backupInitiated"), 'info');
					}
				});
			});
		}
		function showLogs() {
			 HomeyAPI.api('GET', 'getlogs/', function(err, result) {
					if (!err) {
						 document.getElementById('loglines').innerHTML = '';
						 for (var i=(result.length - 1); i >= 0; i--) {
								document.getElementById('loglines').innerHTML += result[i];
								document.getElementById('loglines').innerHTML += "<br />";
						 }
					};
			 });
		}
		function deleteLogs() {
			 HomeyAPI.api('GET', 'deletelogs/', function(err, result) {
				 if (err) {
					 HomeyAPI.alert( err.message, 'error' ); // [, String icon], Function callback )
				 } else { HomeyAPI.alert( 'Logs deleted!', 'info' ); }
			 });
		}

		</script>

  </body>
</html>
